<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="基于Unreal5和TrueSkill的游戏匹配系统-多人在线功能技术文档" /><meta name="author" content="CALL1CE" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="一、Creating a Multiplayer Plugin" /><meta property="og:description" content="一、Creating a Multiplayer Plugin" /><link rel="canonical" href="/posts/%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/" /><meta property="og:url" content="/posts/%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/" /><meta property="og:site_name" content="CALL1CE" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-03T03:45:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="基于Unreal5和TrueSkill的游戏匹配系统-多人在线功能技术文档" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"CALL1CE"},"dateModified":"2022-10-07T05:40:11+00:00","datePublished":"2022-08-03T03:45:00+00:00","description":"一、Creating a Multiplayer Plugin","headline":"基于Unreal5和TrueSkill的游戏匹配系统-多人在线功能技术文档","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"},"url":"/posts/%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"}</script><title>基于Unreal5和TrueSkill的游戏匹配系统-多人在线功能技术文档 | CALL1CE</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="CALL1CE"><meta name="application-name" content="CALL1CE"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/config/CALL1CE.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">CALL1CE</a></div><div class="site-subtitle font-italic">一位正在练习敲代码的OW2玩家</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/CALL1CE" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['563638083','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>基于Unreal5和TrueSkill的游戏匹配系统-多人在线功能技术文档</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>基于Unreal5和TrueSkill的游戏匹配系统-多人在线功能技术文档</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1659498300" data-df="YYYY/MM/DD" data-toggle="tooltip" data-placement="bottom"> 2022/08/03 </em> </span> <span> 更新于 <em class="" data-ts="1665121211" data-df="YYYY/MM/DD" data-toggle="tooltip" data-placement="bottom"> 2022/10/07 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href=""></a> </em>, <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="8919 字"> <em>49 分钟</em>阅读</span></div></div></div><div class="post-content"><h2 id="一creating-a-multiplayer-plugin"><span class="mr-2">一、Creating a Multiplayer Plugin</span><a href="#一creating-a-multiplayer-plugin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="1-multiplayer-concepts"><span class="mr-2">1. Multiplayer Concepts</span><a href="#1-multiplayer-concepts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>Peer-to-peer连接</p><p><a href="https://imgtu.com/i/j3T7Cj" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/03/j3T7Cj.jpg" alt="j3T7Cjjpg" class="lazyload" data-proofer-ignore></a></p><li><p>client-server模式：</p><ul><li><p>listen-server：玩家中一台机器做服务器</p><li><p>dedicated-server：专门的一台服务器</p></ul></ol><p><a href="https://imgtu.com/i/j3To5Q" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/03/j3To5Q.jpg" alt="j3To5Qjpg" class="lazyload" data-proofer-ignore></a></p><ol><li><p>unreal engine multiplayer: authoritative client - server 模式：</p><p>可以根据配置来选择用哪种模式（监听服务器还是专用服务器模式）</p></ol><h3 id="2-testing-multiplayer"><span class="mr-2">2. Testing Multiplayer</span><a href="#2-testing-multiplayer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="21-testing-in-editor"><span class="mr-2">2.1 Testing in editor</span><a href="#21-testing-in-editor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>play按钮右侧的三个点中，可以改变number of player</p><li><p>Net Mode：</p><ul><li><p>play standalone 单机模式</p><li><p>play as listen server，编辑器作为监听服务器</p><li><p>play as client 会创建一个专用服务器</p></ul></ol><h4 id="22-setting-up-lan-connection局域网"><span class="mr-2">2.2 setting up lan connection局域网</span><a href="#22-setting-up-lan-connection局域网" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>创建一个新的level：lobby（大厅），让其他玩家通过局域网连接进入（file-&gt;new level, save current level）</p><li><p>进入Third Person Character蓝图，创建蓝图，按1键打开新level，option填listen，作为监听服务器，2键执行command命令，输入Open 172.22.26.21</p><li><p>获取自己电脑的ip，打开cmd，输入ipconfig得到ipv4地址：IPv4 地址 . . . . . . . . . . . . : 172.22.26.21</p><li><p>打包出package project，放到新建的Build文件夹中</p><li><p>使用两台机器测试，连接同一个网络</p></ol><h3 id="3-lan-connection"><span class="mr-2">3. LAN Connection</span><a href="#3-lan-connection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="31-c创建局域网连接"><span class="mr-2">3.1 C++创建局域网连接</span><a href="#31-c创建局域网连接" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>Source -&gt; MultiplyShooter -&gt; MultiplyShooter.h（打错了，不过没关系，这个项目是用来测试多人玩家的）创建几个函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>  <span class="c1">//可以在蓝图中创建节点</span>
  <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">OpenLobby</span><span class="p">();</span>
  <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">CallOpenLevel</span><span class="p">(</span><span class="k">const</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">Address</span><span class="p">);</span>
  <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">CallClientTravel</span><span class="p">(</span><span class="k">const</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">Address</span><span class="p">);</span>
</pre></table></code></div></div><li><p>在cpp文件实现</p><p>在官方文档查openlevel函数，加入官方文档中提到的头文件<code class="language-plaintext highlighter-rouge">#include "Kismet/GameplayStatics.h"</code></p><p>这里面的CallOpenLevel()和CallClientTravel()函数的功能是一样的</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">AMutiplyShooterCharacter</span><span class="o">::</span><span class="n">OpenLobby</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">//右键level-&gt;get file path : E:/Ue5/MutiplyShooter/Content/ThirdPerson/Maps/Lobby.umap</span>
      <span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="s">"/Game/ThirdPerson/Maps/Lobby?listen"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
   
<span class="kt">void</span> <span class="n">AMutiplyShooterCharacter</span><span class="o">::</span><span class="n">CallOpenLevel</span><span class="p">(</span><span class="k">const</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">Address</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//Address是FString类型，加*就成了C风格的字符串，这个可以隐式地创建FName对象</span>
  <span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">OpenLevel</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">*</span><span class="n">Address</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//让角色传送到ip地址为address的房间去</span>
<span class="kt">void</span> <span class="n">AMutiplyShooterCharacter</span><span class="o">::</span><span class="n">CallClientTravel</span><span class="p">(</span><span class="k">const</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">Address</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//获取本地角色控制器</span>
  <span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerController</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">ClientTravel</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">ETravelType</span><span class="o">::</span><span class="n">TRAVEL_Absolute</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>记得build后再回到编辑器（在vs里如果编译不成功，比如报错Unable to build while Live Coding is active. Exit the editor and game, or press Ctrl+Alt+F11 if iterating on code in the editor or game MutiplyShooter ，就在编辑器里按<strong>CTRL</strong>+<strong>ALT</strong>+<strong>F11</strong>来手动编译，可以编译成功）（或者在Edit -&gt; editor preference中搜索live coding，关掉，就能在vs编译了，而且这样就能打包了，不然用live coding没发打包）</p><li><p>进入角色控制器蓝图</p><p><a href="https://imgtu.com/i/j8KFSg" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/03/j8KFSg.jpg" alt="j8KFSgjpg" class="lazyload" data-proofer-ignore></a></p><li><p>打包测试（测试失败可能是ip地址错误的问题）</p></ol><h3 id="4-online-subsystem"><span class="mr-2">4. Online Subsystem</span><a href="#4-online-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>    为了不输入对方的IP地址就同世界各地的人们一起游戏，需要使用一个服务器服务，比如steam，又为了避免使用不同服务器代码库不同带来的影响，虚幻引擎抽象了一层Online Subsystem，以至于只用写一遍代码，打包成一个插件就可以在配置后连接各种类型服务器的服务，因为虚幻引擎的在线子系统处理了其中的细节。</p><h3 id="5-online-sessions"><span class="mr-2">5. Online Sessions</span><a href="#5-online-sessions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="51-online-subsystem在线子系统"><span class="mr-2">5.1 online subsystem在线子系统</span><a href="#51-online-subsystem在线子系统" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    在线子系统提供了一种访问在线平台服务功能的方式。在线平台，是指像Steam和Xbox Lives等这样的东西。这些平台中的每一个都有自己的一套服务支持，如朋友、成就。设置匹配会话，等等。在线子系统包含一组接口，旨在处理每个平台的这些不同服务。因此无论我们选择哪种服务，都可以用在线子系统来处理我们对这些接口的使用。我们所要做的就是为一个特定的平台配置我们的项目。</p><h4 id="52-session-interface会话接口"><span class="mr-2">5.2 session interface会话接口</span><a href="#52-session-interface会话接口" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    会话接口处理创建、管理和销毁游戏会话。它还处理搜索会话和其他匹配功能。一个会话可以被认为是游戏的一个实例，在服务器上运行，有一系列的属性，并且一个会话可以被公布，以便其他玩家可以找到这个会话并加入进来或者是私人的，所以只有被邀请的人才能加入游戏。</p><p>    一个典型的游戏会话的基本寿命是这样的。</p><ol><li><p>首先，你用一组所需的设置来创建会话。</p><li><p>然后你等待其他玩家的加入，并在他们进来的时候注册每个人。</p><li><p>一旦有足够的玩家加入，你就开始会话。</p><li><p>然后每个玩家都在同一个会话中玩游戏。</p><li><p>一旦比赛结束，你就可以结束会话并取消玩家的注册。</p><li><p>然后你可以更新会话，改变比赛的设置。</p></ol><p>   会话接口函数：CreateSession(), FindSession(), JoinSession(), StartSession(), DestroySession()</p><h4 id="53-game-plan"><span class="mr-2">5.3 game plan</span><a href="#53-game-plan" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    我们的目标是能够在我们游戏的菜单上点击一个按钮。现在，我们先假设我们有两个菜单按钮，Host和Join。</p><p>    当点击host时，我们的代码将配置会话设置，然后调用会话接口函数创建会话。一旦完成这些，我们就可以打开大厅关卡，等待其他玩家加入。</p><p>    然后当别人开始游戏并点击加入，我们将配置一些搜索设置。组属性将有助于过滤掉我们没有兴趣加入的任何游戏会话。然后我们将调用接口函数查找会话。这将返回一些搜索结果，我们将遍历这些结果并挑选一个有效的会话。一旦我们完成了这一工作，我们就能得到适当的P地址，我们可以用ClientTravel()函数来使用。好了，然后用这个函数去旅行到其他玩家那里，收听服务器，并与他们一起加入大厅关卡。</p><p>    现在要把所有这些功能放到它自己的整洁的小类中，用来处理这些会话相关的功能。但我们还不想因为创建所有这些新的类而被淹没。现在，我们将简单地从角色类中访问在线子系统。并在那里调用这些函数，只是为了看看一切是如何运作的。一旦找们对如何便用在线子系统以及它的会话接口功能有了了解。然后创建我们自己的类来处理这些事情，我们将把它设计成可以用于任何我们希望使用它的游戏中。</p><h3 id="6-configure-for-steam"><span class="mr-2">6. Configure For Steam</span><a href="#6-configure-for-steam" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="61-creating-a-new-project"><span class="mr-2">6.1 creating a new project</span><a href="#61-creating-a-new-project" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>创建Third Person项目（C++，starter content），MenuSystem</p><li><p>配置steam</p><li><p>edit -&gt; plugins, 搜索online subsystem steam，勾选enable，然后restart</p><li><p>实际启用steam模块，进入vs，Source -&gt; MenuSystem -&gt; MenuSystem.Build.cs，在<code class="language-plaintext highlighter-rouge">PublicDependencyModuleNames</code>中添加<code class="language-plaintext highlighter-rouge">OnlineSubsystemSteam</code>和<code class="language-plaintext highlighter-rouge">OnlineSubsystem</code></p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PublicDependencyModuleNames</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"Core"</span><span class="p">,</span> <span class="s">"CoreUObject"</span><span class="p">,</span> <span class="s">"Engine"</span><span class="p">,</span> <span class="s">"InputCore"</span><span class="p">,</span> <span class="s">"HeadMountedDisplay"</span><span class="p">,</span> <span class="s">"OnlineSubsystemSteam"</span><span class="p">,</span> <span class="s">"OnlineSubsystem"</span> <span class="p">});</span>
</pre></table></code></div></div></ol><h4 id="62-configure-the-project-for-steam"><span class="mr-2">6.2 configure the project for steam</span><a href="#62-configure-the-project-for-steam" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>打开项目文件夹-&gt;config-&gt;defalutEngine.ini，添加内容</p><li><p>去文档中找到 Online Subsystem Steam，里面有需要粘贴的内容</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nn">[/Script/Engine.GameEngine]</span>
<span class="err">+</span><span class="py">NetDriverDefinitions</span><span class="p">=</span><span class="s">(DefName="GameNetDriver",DriverClassName="OnlineSubsystemSteam.SteamNetDriver",DriverClassNameFallback="OnlineSubsystemUtils.IpNetDriver")</span>
   
<span class="nn">[OnlineSubsystem]</span>
<span class="py">DefaultPlatformService</span><span class="p">=</span><span class="s">Steam</span>
   
<span class="nn">[OnlineSubsystemSteam]</span>
<span class="py">bEnabled</span><span class="p">=</span><span class="s">true</span>
<span class="py">SteamDevAppId</span><span class="p">=</span><span class="s">480</span>
   
<span class="c">; If using Sessions
; bInitServerOnClient=true
</span>   
<span class="nn">[/Script/OnlineSubsystemSteam.SteamNetDriver]</span>
<span class="py">NetConnectionClassName</span><span class="p">=</span><span class="s">"OnlineSubsystemSteam.SteamNetConnection"</span>
</pre></table></code></div></div><li><p>关闭vs和项目，到项目文件夹，删除Saved、Intermediate和Binaries文件夹</p><li><p>右键MenuSystem.uproject，generate visual studio project files</p><li><p>双击MenuSystem.uproject，会提示丢失文件，点击yes就会重新生成</p><li><p>接下来回到项目即可</p></ol><h3 id="7-accessing-the-online-subsystem"><span class="mr-2">7. Accessing the Online Subsystem</span><a href="#7-accessing-the-online-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>进入MenuSystemCharacter.h，在末尾添加关于会话的public部分</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="c1">// 在线对话接口的指针</span>
  <span class="c1">// IOnlineSessionPtr OnlineSessionInterface;</span>
  <span class="c1">// IOnlineSessionPtr是TSharedPtr&lt;class IOnlineSession, ESPMode::ThreadSafe&gt;的别名</span>
  <span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">IOnlineSession</span><span class="p">,</span> <span class="n">ESPMode</span><span class="o">::</span><span class="n">ThreadSafe</span><span class="o">&gt;</span> <span class="n">OnlineSessionInterface</span><span class="p">;</span>
</pre></table></code></div></div><li><p>进入MenuSystemCharacter.cpp，到构造函数的底部，添加代码访问在线子系统</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">IOnlineSubsystem</span><span class="o">*</span> <span class="n">OnlineSubsystem</span> <span class="o">=</span> <span class="n">IOnlineSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">OnlineSubsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">//获取在线会话的接口</span>
      <span class="n">OnlineSessionInterface</span> <span class="o">=</span> <span class="n">OnlineSubsystem</span><span class="o">-&gt;</span><span class="n">GetSessionInterface</span><span class="p">();</span>
      <span class="c1">//检测是否找到在线子系统</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="c1">//不会清除掉之前打印的内容</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span><span class="c1">//持续15s</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Blue</span><span class="p">,</span>
              <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Found subsystem %s"</span><span class="p">),</span> <span class="o">*</span><span class="n">OnlineSubsystem</span><span class="o">-&gt;</span><span class="n">GetSubsystemName</span><span class="p">().</span><span class="n">ToString</span><span class="p">())</span><span class="c1">//GetSubsystemName()得到FName，ToString得到FString，再加个*得到c风格字符串</span>
          <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
</pre></table></code></div></div><li><p>前往文档中的IOnlineSubsystem，去找到需要添加的头文件，并加在cpp文件中<code class="language-plaintext highlighter-rouge">#include "OnlineSubsystem.h"</code></p><li><p>到文档中搜索 IOnlineSession，将需要的头文件添加在cpp文件中<code class="language-plaintext highlighter-rouge">#include "Interfaces/OnlineSessionInterface.h"</code></p><li><p>如果收到报错Unable to delete hot-reload file（但我直接编译成功了，没报错），需要关闭vs和引擎，</p><ul><li><p>删除Saved、Intermediate和Binaries文件夹</p><li><p>右键MenuSystem.uproject，generate visual studio project files</p><li><p>双击MenuSystem.uproject，会提示丢失文件，点击yes就会重新生成</p></ul><li><p>登录steam</p><li><p>在编辑器运行会连接不上，打包后运行就可以连接上</p></ol><h3 id="8-creating-a-session"><span class="mr-2">8. Creating a Session</span><a href="#8-creating-a-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="81-delegate-and-callback"><span class="mr-2">8.1 Delegate and callback</span><a href="#81-delegate-and-callback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在MenuSystemCharacter.h中添加函数（protected）</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nl">protected:</span>
  <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">CreateGameSession</span><span class="p">();</span>
</pre></table></code></div></div><li><p>在MenuSystemCharacter.h中创建一个委托变量(private)</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nl">private:</span>
  <span class="n">FOnCreateSessionCompleteDelegate</span> <span class="n">CreateSessionCompleteDelegate</span><span class="p">;</span>
</pre></table></code></div></div><p>此时会报错：“CreateSessionCompleteDelegate”: 未知重写说明符 MenuSystem</p><p>因为FOnCreateSessionCompleteDelegate是一个typedef的名字，这时可以像之前IOnlineSessionPtr一样写它的原本名字，也可以直接把cpp文件中的<code class="language-plaintext highlighter-rouge">#include "Interfaces/OnlineSessionInterface.h"</code>剪切到头文件去。要注意：这个头文件要放在<code class="language-plaintext highlighter-rouge">#include "MenuSystemCharacter.generated.h"</code>的上方，这时也可以把<code class="language-plaintext highlighter-rouge">TSharedPtr&lt;class IOnlineSession, ESPMode::ThreadSafe&gt;</code>换回<code class="language-plaintext highlighter-rouge">IOnlineSessionPtr</code>了</p><li><p>在MenuSystemCharacter.h的protected下创建回调函数来和刚才创建的委托变量绑定</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</pre></table></code></div></div><li><p>薛定谔的编译，刚才编译报错，只是往<code class="language-plaintext highlighter-rouge">#include "Interfaces/OnlineSessionInterface.h"</code>头文件下加了一个回车，就编译成功了。</p></ol><h4 id="82-bind-the-callback"><span class="mr-2">8.2 Bind the callback</span><a href="#82-bind-the-callback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>在构造函数处为委托变量初始化</ol><p><code class="language-plaintext highlighter-rouge">AMenuSystemCharacter::AMenuSystemCharacter(): CreateSessionCompleteDelegate(FOnCreateSessionCompleteDelegate::CreateUObject(this, &amp;ThisClass::OnCreateSessionComplete))</code></p><p>    其中，ThisClass就是这个类名的typedef</p><h4 id="83-create-a-game-session"><span class="mr-2">8.3 Create a game session</span><a href="#83-create-a-game-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>去cpp文件中构建CreateGameSession函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">AMenuSystemCharacter</span><span class="o">::</span><span class="n">CreateGameSession</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">//当按1时执行回调</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OnlineSessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//检测当前是否有对话</span>
  <span class="k">auto</span> <span class="n">ExitingSession</span> <span class="o">=</span> <span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">GetNamedSession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">);</span>
  <span class="c1">//如果已经有会话</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ExitingSession</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">DestroySession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//将委托加入委托列表</span>
  <span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegate</span><span class="p">);</span>
  <span class="c1">//使用MakeShareable将指针创建为Tshared类型的指针</span>
  <span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="n">FOnlineSessionSettings</span><span class="o">&gt;</span> <span class="n">SessionSettings</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="nf">FOnlineSessionSettings</span><span class="p">());</span>
   <span class="c1">//设置会话设置</span>
   <span class="n">SessionSettings</span><span class="o">-&gt;</span><span class="n">bIsLANMatch</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">//不是lan连接</span>
   <span class="n">SessionSettings</span><span class="o">-&gt;</span><span class="n">NumPublicConnections</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="c1">//可以连接的最大人数</span>
   <span class="n">SessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span><span class="c1">//允许中途加入</span>
   <span class="n">SessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinViaPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span><span class="c1">//允许不同地区的人加入</span>
   <span class="n">SessionSettings</span><span class="o">-&gt;</span><span class="n">bShouldAdvertise</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span><span class="c1">//steam会显示房间供玩家加入</span>
   <span class="n">SessionSettings</span><span class="o">-&gt;</span><span class="n">bUsesPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span><span class="c1">//显示地区</span>
  <span class="c1">//获取角色控制器的指针</span>
  <span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
  <span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="o">*</span><span class="n">SessionSettings</span><span class="p">);</span>
   
<span class="p">}</span>
</pre></table></code></div></div><p>去文档查找FOnlineSessionSettings函数的头文件，并加入cpp文件中。</p></ol><h4 id="84-print-the-session-name"><span class="mr-2">8.4 Print the session name</span><a href="#84-print-the-session-name" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>去构建回调函数OnCreateSessionComplete()</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">AMenuSystemCharacter</span><span class="o">::</span><span class="n">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">)</span><span class="c1">//如果成功创建会话</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="c1">//不清除之前的debug</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Blue</span><span class="p">,</span>
              <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Created ssesion : %s"</span><span class="p">),</span> <span class="o">*</span><span class="n">SessionName</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span>
          <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="c1">//如果没有成功创建会话</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="c1">//不清除之前的debug</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Red</span><span class="p">,</span>
              <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Failed to create session!"</span><span class="p">))</span>
          <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>前往角色蓝图，按1键执行create game session节点</p><li><p>falied create原因：UE5.0.2有些许不同，需要把配置文件中的部分改一下：</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>   <span class="nn">[OnlineSubsystemSteam]</span>
    <span class="py">bEnabled</span><span class="p">=</span><span class="s">true</span>
    <span class="py">SteamDevAppId</span><span class="p">=</span><span class="s">480</span>
   
    <span class="c">; If using Sessions
</span>    <span class="c">; bInitServerOnClient=true
</span></pre></table></code></div></div><p>改为：</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nn">[OnlineSubsystemSteam]</span>
<span class="py">bEnabled</span><span class="p">=</span><span class="s">true</span>
<span class="py">SteamDevAppId</span><span class="p">=</span><span class="s">480</span>
<span class="py">bInitServerOnClient</span><span class="p">=</span><span class="s">true</span>
</pre></table></code></div></div></ol><h3 id="9-setup-for-joining-game-sessions"><span class="mr-2">9. Setup for Joining Game Sessions</span><a href="#9-setup-for-joining-game-sessions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="91-joingamesession"><span class="mr-2">9.1 JoinGameSession()</span><a href="#91-joingamesession" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在MenuSystem.h文件中protected下创建一个蓝图节点函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>  <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">JoinGameSession</span><span class="p">();</span>
</pre></table></code></div></div><li><p>去cpp文件中实现函数（会在之后实现）</p></ol><h4 id="92-delegate-and-callback"><span class="mr-2">9.2 Delegate and callback</span><a href="#92-delegate-and-callback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>接下来会像创建会话时一样创建委托和回调，在MenuSystem.h文件中的private下创建join会话的委托变量。</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">FOnFindSessionsCompleteDelegate</span> <span class="n">FindSessionsCompleteDelagate</span><span class="p">;</span>
</pre></table></code></div></div><li><p>在protected下创建回调函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</pre></table></code></div></div><li><p>去cpp文件实现回调</p></ol><h4 id="93-binding-the-callback"><span class="mr-2">9.3 Binding the callback</span><a href="#93-binding-the-callback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在cpp的构造函数处为委托绑定回调</p><p><code class="language-plaintext highlighter-rouge">FindSessionsCompleteDelegate(FOnFindSessionsCompleteDelegate::CreateUObject(this, &amp;ThisClass::OnFindSessionsComplete))</code></p></ol><h4 id="94-session-search-settings"><span class="mr-2">9.4 Session search settings</span><a href="#94-session-search-settings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>实现JoinGameSession函数，（其中SessionSearch在头文件中的private下创建变量<code class="language-plaintext highlighter-rouge">TSharedPtr&lt;FOnlineSessionSearch&gt; SessionSearch</code>,因为要在回调函数中使用这个变量来获取会话结果数组）</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">AMenuSystemCharacter</span><span class="o">::</span><span class="n">JoinGameSession</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">//寻找会话</span>
  <span class="c1">//先判断在线会话接口的有效性</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OnlineSessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//将委托变量加入委托列表</span>
  <span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegate</span><span class="p">);</span>
  <span class="c1">//创建会话设置的智能指针,将类的指针makesharable</span>
  <span class="n">SessionSearch</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="nf">FOnlineSessionSearch</span><span class="p">());</span>
  <span class="n">SessionSearch</span><span class="o">-&gt;</span><span class="n">MaxSearchResults</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span><span class="c1">//最大搜索个数</span>
  <span class="n">SessionSearch</span><span class="o">-&gt;</span><span class="n">bIsLanQuery</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">//禁止局域网的搜索</span>
  <span class="c1">//获取角色控制器</span>
  <span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
  <span class="c1">//执行在线会话接口的寻找会话的函数</span>
  <span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">FindSessions</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">SessionSearch</span><span class="p">.</span><span class="n">ToSharedRef</span><span class="p">());</span><span class="c1">//将ptr转为ref</span>
   
<span class="p">}</span>
</pre></table></code></div></div><li><p>实现回调函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">AMenuSystemCharacter</span><span class="o">::</span><span class="n">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//遍历寻找到的会话数组</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">Result</span> <span class="o">:</span> <span class="n">SessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">FString</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="n">GetSessionIdStr</span><span class="p">();</span><span class="c1">//会话Id</span>
      <span class="n">FString</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">OwningUserName</span><span class="p">;</span><span class="c1">//会话创建者的名字</span>
      <span class="c1">//打印出来</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Cyan</span><span class="p">,</span>
              <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Id : %s, User : %s"</span><span class="p">),</span> <span class="o">*</span><span class="n">Id</span><span class="p">,</span> <span class="o">*</span><span class="n">User</span><span class="p">)</span>
          <span class="p">);</span>
      <span class="p">}</span>
   
  <span class="p">}</span>
   
<span class="p">}</span>
</pre></table></code></div></div><li><p>到JoinGameSession函数中，在找之前添加一个SessionSearch的设置</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">//确保搜索的 会话询问 设置为 现在存在</span>
  <span class="n">SessionSearch</span><span class="o">-&gt;</span><span class="n">QuerySettings</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">SEARCH_PRESENCE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">EOnlineComparisonOp</span><span class="o">::</span><span class="n">Equals</span><span class="p">);</span>
</pre></table></code></div></div><li><p>去蓝图中添加节点，按2时执行JoinGameSession</p><li><p>由于5.0.2版本问题导致出错，需要在CreateSession函数中添加一条SessionSettings：<code class="language-plaintext highlighter-rouge">SessionSettings-&gt;bUseLobbiesIfAvailable = true;</code>而且要regenerate（可能就是没有重新生成，所以失败了）</p><li><p>打包，用两台机器测试</p><li><p>在joingamesession的函数里，<code class="language-plaintext highlighter-rouge">MakeShareable(new FOnlineSessionSearch());</code>这处代码的new FOnlineSessionSearch的后面一开始没有加()，也没报错，不知道是不是这里的原因导致找不到会话</p></ol><h3 id="10-steam-regions"><span class="mr-2">10. Steam Regions</span><a href="#10-steam-regions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>    之前一直搜索不到人，一直以为是代码哪里出问题了，原来不是代码出问题了，是steam区域的问题，这个搜索只能搜索到同一区域的人，要到steamm的设置中去更改</p><p><a href="https://imgtu.com/i/jaMmkQ" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/06/jaMmkQ.jpg" alt="jaMmkQjpg" class="lazyload" data-proofer-ignore></a></p><h3 id="11-joining-the-session"><span class="mr-2">11. Joining the Session</span><a href="#11-joining-the-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="111-create-a-lobby-level"><span class="mr-2">11.1 Create a lobby level</span><a href="#111-create-a-lobby-level" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在Maps文件夹中file-&gt;new level，将地板scale放大点，保存为Lobby</p><li><p>在OnCreateSessionComplete函数中添加跳转代码：</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">)</span><span class="c1">//如果成功创建会话</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="c1">//不清除之前的debug</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Blue</span><span class="p">,</span>
              <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Created ssesion : %s"</span><span class="p">),</span> <span class="o">*</span><span class="n">SessionName</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span>
          <span class="p">);</span>
      <span class="p">}</span>
      <span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="c1">//E:/Ue5/MenuSystem/Content/ThirdPerson/Maps/Lobby.umap</span>
          <span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="n">FString</span><span class="p">(</span><span class="s">"/Game/ThirdPerson/Maps/Lobby?listen"</span><span class="p">));</span><span class="c1">//作为监听服务器</span>
      <span class="p">}</span>
  <span class="p">}</span>
</pre></table></code></div></div></ol><h4 id="112-specify-a-match-type"><span class="mr-2">11.2 Specify a “match type”</span><a href="#112-specify-a-match-type" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    在CreateGameSession()函数中添加一条设置</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">//设置游戏模式</span>
    <span class="n">SessionSettings</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">"MatchType"</span><span class="p">),</span> <span class="n">FString</span><span class="p">(</span><span class="s">"FreeForAll"</span><span class="p">),</span> <span class="n">EOnlineDataAdvertisementType</span><span class="o">::</span><span class="n">ViaOnlineServiceAndPing</span><span class="p">);</span>
</pre></table></code></div></div><h4 id="113-check-the-match-type"><span class="mr-2">11.3 Check the match type</span><a href="#113-check-the-match-type" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    在OnFindSessionsComplete函数的遍历中，获取matchtype，并检查</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">Result</span> <span class="o">:</span> <span class="n">SessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">FString</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="n">GetSessionIdStr</span><span class="p">();</span><span class="c1">//会话Id</span>
        <span class="n">FString</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">OwningUserName</span><span class="p">;</span><span class="c1">//会话创建者的名字</span>
        <span class="n">FString</span> <span class="n">MatchType</span><span class="p">;</span><span class="c1">//比赛类型</span>
        <span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">"MatchType"</span><span class="p">),</span> <span class="n">MatchType</span><span class="p">);</span>
        <span class="c1">//打印出来</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
                <span class="n">FColor</span><span class="o">::</span><span class="n">Cyan</span><span class="p">,</span>
                <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Id : %s, User : %s"</span><span class="p">),</span> <span class="o">*</span><span class="n">Id</span><span class="p">,</span> <span class="o">*</span><span class="n">User</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">MatchType</span> <span class="o">==</span> <span class="n">FString</span><span class="p">(</span><span class="s">"FreeForAll"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
                    <span class="n">FColor</span><span class="o">::</span><span class="n">Cyan</span><span class="p">,</span>
                    <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Joing Match Type : %s"</span><span class="p">),</span> <span class="o">*</span><span class="n">MatchType</span><span class="p">)</span>
                <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><h4 id="114-get-the-ip-address"><span class="mr-2">11.4 get the ip address</span><a href="#114-get-the-ip-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在头文件的private下，创建加入会话完成的委托<code class="language-plaintext highlighter-rouge">FOnJoinSessionCompleteDelegate JoinSessionCompleteDelegate;//加入会话完成的委托</code></p><li><p>在头文件的protected下，加入会话完成创建回调函数<code class="language-plaintext highlighter-rouge">void OnJoinSessionComplete(FName SessionName, EOnJoinSessionCompleteResult::Type Result);//加入会话完成的回调函数</code></p><li><p>绑定委托<code class="language-plaintext highlighter-rouge">JoinSessionCompleteDelegate(FOnJoinSessionCompleteDelegate::CreateUObject(this, &amp;ThisClass::OnJoinSessionComplete))</code></p><li><p>修改OnFindSessionsComplete函数，现在开头加上</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OnlineSessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>在模式对的情况下，为接口加入委托，并执行join</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">//加到委托列表中去</span>
<span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegate</span><span class="p">);</span>
<span class="c1">//获取角色控制器</span>
<span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
<span class="c1">//加入会话</span>
<span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">JoinSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">Result</span><span class="p">);</span>
</pre></table></code></div></div></ol><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>5. 实现join的回调函数

```cpp
void AMenuSystemCharacter::OnJoinSessionComplete(FName SessionName, EOnJoinSessionCompleteResult::Type Result)
{
    if (!OnlineSessionInterface.IsValid())
    {
        return;
    }
    FString Address;
    if (OnlineSessionInterface-&gt;GetResolvedConnectString(NAME_GameSession, Address))
    {
        if (GEngine)
        {
            GEngine-&gt;AddOnScreenDebugMessage(
                -1,
                15.f,
                FColor::Yellow,
                FString::Printf(TEXT("Connect String : %s"), *Address)
            );
        }
    }
}
</pre></table></code></div></div><h4 id="115-join-the-session"><span class="mr-2">11.5 join the session</span><a href="#115-join-the-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    在join的回调函数中添加跳转场景</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">AMenuSystemCharacter</span><span class="o">::</span><span class="n">OnJoinSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OnlineSessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">FString</span> <span class="n">Address</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">OnlineSessionInterface</span><span class="o">-&gt;</span><span class="n">GetResolvedConnectString</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">Address</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
                <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
                <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Connect String : %s"</span><span class="p">),</span> <span class="o">*</span><span class="n">Address</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">//获得角色控制器指针</span>
        <span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerController</span><span class="p">();</span>
        <span class="c1">//跳转场景</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">ClientTravel</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">ETravelType</span><span class="o">::</span><span class="n">TRAVEL_Absolute</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="12-creating-a-plugin"><span class="mr-2">12. Creating a Plugin</span><a href="#12-creating-a-plugin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>plugins插件和modules模块</p><p><a href="https://imgtu.com/i/jagWXq" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/06/jagWXq.jpg" alt="jagWXqjpg" class="lazyload" data-proofer-ignore></a></p><li><p>我们的项目文件uproject其实就是一个module</p><li><p>依赖关系，下层只能依赖同层和上层，比game module能依赖engine module，因为先有engine module才有game module</p><p><a href="https://imgtu.com/i/jaRwo8" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/06/jaRwo8.jpg" alt="jaRwo8jpg" class="lazyload" data-proofer-ignore></a></p></ol><h4 id="121-create-our-plugin"><span class="mr-2">12.1 Create our plugin</span><a href="#121-create-our-plugin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>Edit-&gt;Plugins，点击add，选择blank命名MultiplayerSessions，填写descriptor data:A plugin for handling online mutiplayer sessions，最后创建插件</p><li><p>如果不显示插件，可以点content drawer的settings勾选显示插件</p><li><p>编译文件</p></ol><h4 id="122-add-dependency"><span class="mr-2">12.2 Add dependency</span><a href="#122-add-dependency" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>找到刚创建的MultiplayerSessions.uplugin文件，添加依赖：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>  "Plugins": [
      {
          "Name": "OnlineSubsystem",
          "Enabled": true
      },
      {
          "Name": "OnlineSubsystemSteam",
          "Enabled": true
      }
  ]
</pre></table></code></div></div><li><p>打开MultiplayerSession.Build.cs，添加public依赖模块：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>      <span class="n">PublicDependencyModuleNames</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span>
          <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span>
          <span class="p">{</span>
              <span class="s">"Core"</span><span class="p">,</span>
              <span class="s">"OnlineSubsystem"</span><span class="p">,</span>
              <span class="s">"OnlineSubsystemSteam"</span>
              <span class="c1">// ... add other public dependencies that you statically link with here ...</span>
          <span class="p">}</span>
          <span class="p">);</span>
</pre></table></code></div></div><li><p>编译文件</p></ol><h3 id="13-creating-our-own-subsystem"><span class="mr-2">13. Creating our Own Subsystem</span><a href="#13-creating-our-own-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>父类的选择：Game instance</p><p><a href="https://imgtu.com/i/jwK9qf" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/07/jwK9qf.jpg" alt="jwK9qfjpg" class="lazyload" data-proofer-ignore></a></p></ol><h4 id="131-create-our-own-subsystem"><span class="mr-2">13.1 Create our own subsystem</span><a href="#131-create-our-own-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>创建一个新的c++类，选择ugameinstancesubsystem，选择multiplayerSessions 模块，命名MultiplayerSessionsSubsystem</p><li><p>如果有红色波浪线报错的话，就重新generate一下uproject，要记得将plugins中MultiPlayerSessions文件夹中的二进制文件夹和intermediate文件夹删掉</p><li><p>在MultiplayerSubsystem.h中添加一些头文件和构造函数声明、变量声明</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="cp">#pragma once
</span>   
<span class="cp">#include</span> <span class="cpf">"CoreMinimal.h"</span><span class="cp">
#include</span> <span class="cpf">"Subsystems/GameInstanceSubsystem.h"</span><span class="cp">
#include</span> <span class="cpf">"Interfaces/OnlineSessionInterface.h"</span><span class="cp">
</span>   
<span class="cp">#include</span> <span class="cpf">"MultiplayerSubsystem.generated.h"</span><span class="cp">
</span>   
<span class="cm">/**
* 
*/</span>
<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">MULTIPLAYERSESSIONS_API</span> <span class="n">UMultiplayerSubsystem</span> <span class="o">:</span> <span class="k">public</span> <span class="n">UGameInstanceSubsystem</span>
<span class="p">{</span>
  <span class="n">GENERATED_BODY</span><span class="p">()</span>
<span class="nl">public:</span>
  <span class="n">UMutiplayerSubsystem</span><span class="p">();</span>
   
<span class="nl">protected:</span>
   
<span class="nl">private:</span>
  <span class="n">IOnlineSessionPtr</span> <span class="n">SessionInterface</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><li><p>在MultiplayerSubsystem.cpp中实现构造函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"MultiplayerSubsystem.h"</span><span class="cp">
#include</span> <span class="cpf">"OnlineSubsystem.h"</span><span class="cp">
</span><span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">UMultiplayerSubsystem</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">IOnlineSubsystem</span><span class="o">*</span> <span class="n">Subsystem</span> <span class="o">=</span> <span class="n">IOnlineSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span> <span class="o">=</span> <span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">GetSessionInterface</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div></ol><h4 id="14-session-interface-delegates"><span class="mr-2">14. Session Interface Delegates</span><a href="#14-session-interface-delegates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>需要实现的方法：</p><p><a href="https://imgtu.com/i/jw8ny9" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/07/jw8ny9.jpg" alt="jw8ny9jpg" class="lazyload" data-proofer-ignore></a></p><li><p>delegate handle：当委托完成后，clear掉</p><p><a href="https://imgtu.com/i/jw8Zz4" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/07/jw8Zz4.jpg" alt="jw8Zz4jpg" class="lazyload" data-proofer-ignore></a></p></ol><h4 id="141-functions"><span class="mr-2">14.1 Functions</span><a href="#141-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在头文件声明函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="n">UMultiplayerSubsystem</span><span class="p">();</span>
  <span class="c1">//</span>
  <span class="c1">//处理会话功能，菜单类将会调用</span>
  <span class="c1">//</span>
  <span class="kt">void</span> <span class="nf">CreateSession</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">MatchType</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">FindSessions</span><span class="p">(</span><span class="n">int32</span> <span class="n">MaxSearchResults</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">JoinSession</span><span class="p">(</span><span class="k">const</span> <span class="n">FOnlineSessionSearchResult</span><span class="o">&amp;</span> <span class="n">SessionResult</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">DestroySession</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">StartSession</span><span class="p">();</span>
</pre></table></code></div></div></ol><h4 id="142-delegates"><span class="mr-2">14.2 Delegates</span><a href="#142-delegates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在头文件添加委托变量</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nl">private:</span>
  <span class="n">IOnlineSessionPtr</span> <span class="n">SessionInterface</span><span class="p">;</span>
   
  <span class="c1">//</span>
  <span class="c1">//要添加在线会话接口的委托列表中的委托</span>
  <span class="c1">//将绑定MultiplayerSubsystem内部回调函数到这些委托</span>
  <span class="c1">//</span>
  <span class="n">FOnCreateSessionCompleteDelegate</span> <span class="n">CreateSessionCompleteDelegate</span><span class="p">;</span>
  <span class="n">FOnFindSessionsCompleteDelegate</span> <span class="n">FindSessionsCompleteDelegate</span><span class="p">;</span>
  <span class="n">FOnJoinSessionCompleteDelegate</span> <span class="n">JoinSessionCompleteDelegate</span><span class="p">;</span>
  <span class="n">FOnDestroySessionCompleteDelegate</span> <span class="n">DestroySessionCompleteDelegate</span><span class="p">;</span>
  <span class="n">FOnStartSessionCompleteDelegate</span> <span class="n">StartSessionCompleteDelegate</span><span class="p">;</span>
</pre></table></code></div></div></ol><h4 id="143-callbacks"><span class="mr-2">14.3 Callbacks</span><a href="#143-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在头文件中声明回调函数（protected）</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nl">protected:</span>
  <span class="c1">//</span>
  <span class="c1">//将要添加在 在线会话接口委托列表中委托的 内部回调函数</span>
  <span class="c1">//因为不需要在这个类外调用，所以写在protected里</span>
  <span class="kt">void</span> <span class="nf">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">OnJoinSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">OnDestroySessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">OnStartSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
<span class="n">ssful</span><span class="p">);</span>
</pre></table></code></div></div></ol><h4 id="144-bind-the-callbacks"><span class="mr-2">14.4 Bind the callbacks</span><a href="#144-bind-the-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在cpp文件的构造函数下初始化，绑定委托和回调函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">UMultiplayerSubsystem</span><span class="p">()</span><span class="o">:</span>
<span class="n">CreateSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnCreateSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSessionComplete</span><span class="p">)),</span>
<span class="n">FindSessionsCompleteDelegate</span><span class="p">(</span><span class="n">FOnFindSessionsCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnFindSessionsComplete</span><span class="p">)),</span>
<span class="n">JoinSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnJoinSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnJoinSessionComplete</span><span class="p">)),</span>
<span class="n">DestroySessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnDestroySessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnDestroySessionComplete</span><span class="p">)),</span>
<span class="n">StartSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnStartSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnStartSessionComplete</span><span class="p">))</span>
</pre></table></code></div></div></ol><h4 id="145-dekegate-handles"><span class="mr-2">14.5 Dekegate handles</span><a href="#145-dekegate-handles" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在头文件中为每一个委托创建delegate handle</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>  <span class="n">FOnCreateSessionCompleteDelegate</span> <span class="n">CreateSessionCompleteDelegate</span><span class="p">;</span>
  <span class="n">FDelegateHandle</span> <span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">;</span>
  <span class="n">FOnFindSessionsCompleteDelegate</span> <span class="n">FindSessionsCompleteDelegate</span><span class="p">;</span>
  <span class="n">FDelegateHandle</span> <span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">;</span>
  <span class="n">FOnJoinSessionCompleteDelegate</span> <span class="n">JoinSessionCompleteDelegate</span><span class="p">;</span>
  <span class="n">FDelegateHandle</span> <span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">;</span>
  <span class="n">FOnDestroySessionCompleteDelegate</span> <span class="n">DestroySessionCompleteDelegate</span><span class="p">;</span>
  <span class="n">FDelegateHandle</span> <span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">;</span>
  <span class="n">FOnStartSessionCompleteDelegate</span> <span class="n">StartSessionCompleteDelegate</span><span class="p">;</span>
  <span class="n">FDelegateHandle</span> <span class="n">StartSessionCompleteDelegateHandle</span><span class="p">;</span>
</pre></table></code></div></div><li><p>编译文件</p></ol><h3 id="15-the-menu-class"><span class="mr-2">15. The Menu Class</span><a href="#15-the-menu-class" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="151-create-a-menu-class"><span class="mr-2">15.1 Create a menu class</span><a href="#151-create-a-menu-class" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在MultiplayerSessionsC++Class-&gt;MultiplySessions-&gt;Public文件夹中创建新的c++类，搜索uuserwidget，选择UserWidget，下一步选择MultiplayerSessions，命名Menu</p><li><p>此时重新加载后，编译无法通过，尝试重新generate(千万不要！！！会打不开项目)</p><li><p>打开MultiplayerSessions.Build.cs文件，在PublicDependencyModuleNames.AddRange中添加引用依赖，解决了报错，再编译一下，就能打开项目了</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>      <span class="n">PublicDependencyModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span>
          <span class="k">new</span> <span class="n">string</span><span class="p">[]</span>
          <span class="p">{</span>
              <span class="s">"Core"</span><span class="p">,</span>
              <span class="s">"OnlineSubsystem"</span><span class="p">,</span>
              <span class="s">"OnlineSubsystemSteam"</span><span class="p">,</span>
              <span class="s">"UMG"</span><span class="p">,</span>
              <span class="s">"Slate"</span><span class="p">,</span>
              <span class="s">"SlateCore"</span>
              <span class="c1">// ... add other public dependencies that you statically link with here ...</span>
          <span class="p">}</span>
          <span class="p">);</span>
</pre></table></code></div></div><li><p>在Menu .h添加函数声明</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">MenuSetup</span><span class="p">();</span>
</pre></table></code></div></div><li><p>在cpp中实现</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">MenuSetup</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">AddToViewport</span><span class="p">();</span><span class="c1">//添加到窗口</span>
  <span class="n">SetVisibility</span><span class="p">(</span><span class="n">ESlateVisibility</span><span class="o">::</span><span class="n">Visible</span><span class="p">);</span><span class="c1">//设置为可见</span>
  <span class="n">bIsFocusable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
   
  <span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">World</span><span class="o">-&gt;</span><span class="n">GetFirstPlayerController</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="c1">//设置input的模式为UI模式，并设置其中的属性</span>
          <span class="n">FInputModeUIOnly</span> <span class="n">InputModeData</span><span class="p">;</span>
          <span class="n">InputModeData</span><span class="p">.</span><span class="n">SetWidgetToFocus</span><span class="p">(</span><span class="n">TakeWidget</span><span class="p">());</span><span class="c1">//聚焦这个界面</span>
          <span class="n">InputModeData</span><span class="p">.</span><span class="n">SetLockMouseToViewportBehavior</span><span class="p">(</span><span class="n">EMouseLockMode</span><span class="o">::</span><span class="n">DoNotLock</span><span class="p">);</span><span class="c1">//设置鼠标不锁定模式</span>
          <span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetInputMode</span><span class="p">(</span><span class="n">InputModeData</span><span class="p">);</span><span class="c1">//设置输入模式</span>
          <span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetShowMouseCursor</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="c1">//鼠标光标可见</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div></ol><h4 id="152-create-a-menu-widget"><span class="mr-2">15.2 Create a menu widget</span><a href="#152-create-a-menu-widget" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在MultiplayerSessions Content文件夹中创建user interface-&gt;widget，命名UBP_Menu</p><li><p>进入UBP_Menu的设计模式，创建两个按钮，一个HostButton，一个JoinButton，将锚点设置成底部中心，调整按钮位置和大小</p><li><p>进入蓝图模式，点击class settings，将parent class设置为Menu</p><li><p>进入level blueprint，创建beginPlay节点，指向create widget节点，选择UBP_Menu，指向MenuSetup节点，return value连接target（如果没有menu set节点的话就尝试重启项目）</p><p><a href="https://imgtu.com/i/j0CjSO" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/07/j0CjSO.jpg" alt="j0CjSOjpg" class="lazyload" data-proofer-ignore></a></p></ol><h3 id="16-accessing-our-subsystem"><span class="mr-2">16. Accessing our Subsystem</span><a href="#16-accessing-our-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="161-button-callbacks"><span class="mr-2">16.1 Button callbacks</span><a href="#161-button-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>到Menu.h文件中为按钮创建变量</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nl">private:</span>
   
  <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">BindWidget</span><span class="p">))</span><span class="c1">//要和界面的按钮控件绑定，就要加这个，而且变量名要和界面中创建的一致</span>
  <span class="k">class</span> <span class="nc">UButton</span><span class="o">*</span> <span class="n">HostButton</span><span class="p">;</span>
   
  <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">BindWidget</span><span class="p">))</span>
  <span class="n">UButton</span><span class="o">*</span> <span class="n">JoinButton</span><span class="p">;</span>
   
  <span class="n">UFUNCTION</span><span class="p">()</span><span class="c1">//因为要使用引擎的click事件或者委托，所以加上这个</span>
  <span class="kt">void</span> <span class="nf">HostButtonClicked</span><span class="p">();</span>
   
  <span class="n">UFUNCTION</span><span class="p">()</span>
  <span class="kt">void</span> <span class="nf">JoinButtonClicked</span><span class="p">();</span>
</pre></table></code></div></div><li><p>实现按钮事件（其实就是debug一下先）</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">HostButtonClicked</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
          <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
          <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
          <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Host Button clicked"</span><span class="p">))</span>
          <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
   
<span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">JoinButtonClicked</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
          <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
          <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
          <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Join Button clicked"</span><span class="p">))</span>
      <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>接下来将事件绑定到按钮上，要先在头文件重写一下初始化函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nl">protected:</span>
   
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Initialize</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</pre></table></code></div></div><li><p>在cpp文件中添加头文件<code class="language-plaintext highlighter-rouge">#include "Components/Button.h"</code></p><li><p>实现initialize函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kt">bool</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">Initialize</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Super</span><span class="o">::</span><span class="n">Initialize</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
   
  <span class="k">if</span> <span class="p">(</span><span class="n">HostButton</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">HostButton</span><span class="o">-&gt;</span><span class="n">OnClicked</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">HostButtonClicked</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">JoinButton</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">OnClicked</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">JoinButtonClicked</span><span class="p">);</span>
  <span class="p">}</span>
   
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>编译并测试(如果没反应，可以尝试下重启项目，再不行就重新generate一下)</p></ol><h4 id="162-access-our-subsystem"><span class="mr-2">16.2 Access our subsystem</span><a href="#162-access-our-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在menu.h的private中声明变量，我的类名叫UMultiplayerSubsyste，是因为创建类的时候少打了session，删除类也有点麻烦，所以也就没改名了</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">//管理所有在线会话的功能</span>
  <span class="k">class</span> <span class="nc">UMultiplayerSubsystem</span><span class="o">*</span> <span class="n">MultiplayerSessionsSubsystem</span><span class="p">;</span>
</pre></table></code></div></div><li><p>在cpp文件中，丰富menusetup函数，并添加MutiplayerSubsystem的头文件</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>  <span class="n">UGameInstance</span><span class="o">*</span> <span class="n">GameInstance</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">GameInstance</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">//为之前创建的变量赋值</span>
      <span class="n">MultiplayerSessionsSubsystem</span> <span class="o">=</span> <span class="n">GameInstance</span><span class="o">-&gt;</span><span class="n">GetSubsystem</span><span class="o">&lt;</span><span class="n">UMultiplayerSubsystem</span><span class="o">&gt;</span><span class="p">();</span>
   
  <span class="p">}</span>
</pre></table></code></div></div><li><p>修改button的响应函数(具体实现在下一节)</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">HostButtonClicked</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
          <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
          <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
          <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Host Button clicked"</span><span class="p">))</span>
          <span class="p">);</span>
  <span class="p">}</span>
   
  <span class="k">if</span> <span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">FString</span><span class="p">(</span><span class="s">"FreeForAll"</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div></ol><h3 id="17-create-session"><span class="mr-2">17. Create Session</span><a href="#17-create-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="171-implement-createsession"><span class="mr-2">17.1 Implement CreateSession()</span><a href="#171-implement-createsession" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>实现MultiplayerSubsystem.cpp的CreateSession函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">CreateSession</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">MatchType</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//判断是否存在NAME_GameSession的会话</span>
  <span class="k">auto</span> <span class="n">ExistingSession</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">GetNamedSession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ExistingSession</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">DestroySession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//将委托加入委托列表，并保存至handle中以便之后消除</span>
  <span class="n">CreateSessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegate</span><span class="p">);</span>
   
  <span class="n">LastSessionSettings</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="nf">FOnlineSessionSettings</span><span class="p">());</span>
  <span class="c1">//如果没连接steam那就是局域网连接，否则不是</span>
  <span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bIsLANMatch</span> <span class="o">=</span> <span class="n">IOnlineSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSubsystemName</span><span class="p">()</span> <span class="o">==</span> <span class="s">"NULL"</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">NumPublicConnections</span> <span class="o">=</span> <span class="n">NumPublicConnections</span><span class="p">;</span>
  <span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinViaPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bShouldAdvertise</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bUsesPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">"MatchType"</span><span class="p">),</span> <span class="n">MatchType</span><span class="p">,</span> <span class="n">EOnlineDataAdvertisementType</span><span class="o">::</span><span class="n">ViaOnlineServiceAndPing</span><span class="p">);</span><span class="c1">//这个应该是指显示出在线服务和ping值</span>
   
  <span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
  <span class="c1">//如果创建会话失败，那么就消除委托列表中的创建委托</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="o">*</span><span class="n">LastSessionSettings</span><span class="p">))</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">);</span>
  <span class="p">}</span>
   
<span class="p">}</span>
</pre></table></code></div></div><li><p>在头文件创建私有变量：<code class="language-plaintext highlighter-rouge">TSharedPtr&lt;FOnlineSessionSettings&gt; LastSessionSettings;</code></p><li><p>在cpp文件包含头文件：<code class="language-plaintext highlighter-rouge">#include "OnlineSessionSettings.h"</code></p></ol><h4 id="172-travel-to-the-lobby"><span class="mr-2">17.2 Travel to the lobby</span><a href="#172-travel-to-the-lobby" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>在menu.cpp文件中丰富HostButtonClicked()</ol><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">FString</span><span class="p">(</span><span class="s">"FreeForAll"</span><span class="p">));</span>
        <span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="s">"/Game/ThirdPerson/Maps/Lobby?listen"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><ol><li><p>编译并测试，不需要打包的测试方法：右键uproject-&gt;lauch game</p><li><p>测试失败，没有跳转场景，查了下，发现是ServerTravel里路径参数写错了，还得是去copy path最保险</p><li><p>在menu.h中声明一个私有函数MenuTearDown，用来解除inputmodeUI</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">MenuTearDown</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">RemoveFromParent</span><span class="p">();</span>
   
  <span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">World</span><span class="o">-&gt;</span><span class="n">GetFirstPlayerController</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">FInputModeGameOnly</span> <span class="n">InputModeData</span><span class="p">;</span>
          <span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetInputMode</span><span class="p">(</span><span class="n">InputModeData</span><span class="p">);</span>
          <span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetShowMouseCursor</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>重写Menu类的虚函数OnLevelRemovedFromWorld() (protected)</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnLevelRemovedFromWorld</span><span class="p">(</span><span class="n">ULevel</span><span class="o">*</span> <span class="n">InLevel</span><span class="p">,</span> <span class="n">UWorld</span><span class="o">*</span> <span class="n">InWorld</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">MenuTearDown</span><span class="p">();</span>
  <span class="c1">//调用父级的函数</span>
  <span class="n">Super</span><span class="o">::</span><span class="n">OnLevelRemovedFromWorld</span><span class="p">(</span><span class="n">InLevel</span><span class="p">,</span> <span class="n">InWorld</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div></ol><h4 id="173-add-input-to-menusetup"><span class="mr-2">17.3 Add Input to MenuSetup</span><a href="#173-add-input-to-menusetup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在头文件中添加私有变量并初始化</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">int32</span> <span class="n">NumPublicConnection</span><span class="p">{</span> <span class="mi">4</span> <span class="p">};</span>
<span class="n">FString</span> <span class="n">MatchType</span><span class="p">{</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"FreeForAll"</span><span class="p">)</span> <span class="p">};</span>
</pre></table></code></div></div><li><p>修改menuSetup函数（参数也要修改,头文件中要设置默认值），主要就是给变量赋初值</p><p><code class="language-plaintext highlighter-rouge">void MenuSetup(int32 NumberOfPublicConnections = 4 , FString TypeOfMatch = FString(TEXT("FreeForAll")));</code></p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">MenuSetup</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumberOfPublicConnections</span> <span class="p">,</span> <span class="n">FString</span> <span class="n">TypeOfMatch</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">NumPublicConnection</span> <span class="o">=</span> <span class="n">NumberOfPublicConnections</span><span class="p">;</span>
  <span class="n">MatchType</span> <span class="o">=</span> <span class="n">TypeOfMatch</span><span class="p">;</span>
</pre></table></code></div></div><li><p>修改HostButtonClicked()函数中，createSession的参数，改成变量</p><p><code class="language-plaintext highlighter-rouge">MultiplayerSessionsSubsystem-&gt;CreateSession(NumPublicConnection, MatchType);</code></p><li><p>此时打开level bliprint可能会看到menu setup节点没有添加变量，重启下项目即可</p></ol><h3 id="18-callbacks-to-our-subsystem-functions"><span class="mr-2">18. Callbacks to our Subsystem Functions</span><a href="#18-callbacks-to-our-subsystem-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>    使用自定义的委托，在执行完会话创建的委托回调函数后，创建自定义委托来执行menu类的回调函数，以此来使multiplayer session subsystem可以与menu类实现互通</p><p><a href="https://imgtu.com/i/j04JRf" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/08/j04JRf.jpg" alt="j04JRfjpg" class="lazyload" data-proofer-ignore></a></p><h4 id="181-declare-new-delegate"><span class="mr-2">18.1 Declare new delegate</span><a href="#181-declare-new-delegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在MultiplayerSubsystem.h中声明自定义委托（动态多播委托：多个类的回调函数都可以绑定这个委托，DYNAMIC意味着被序列化，而且可以在蓝图中加载和保存），并创建public变量，声明在类外(可能会报错有红色波浪线，没关系，做完这一节，最后重启项目和vs再编译一遍即可)</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnCreateSessionComplete</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</pre></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="c1">//</span>
  <span class="c1">//自定义委托变量（用于和menu类的回调函数绑定）</span>
  <span class="c1">//</span>
  <span class="n">FMultiplayerOnCreateSessionComplete</span> <span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">;</span>
</pre></table></code></div></div></ol><h4 id="182-create-callbacks-on-the-menu"><span class="mr-2">18.2 Create callbacks on the menu</span><a href="#182-create-callbacks-on-the-menu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在menu.h中声明回调函数（protected）</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="c1">//</span>
  <span class="c1">//回调函数（用于MultiplayerSystem的自定义委托）</span>
  <span class="c1">//</span>
  <span class="kt">void</span> <span class="nf">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</pre></table></code></div></div></ol><h4 id="183-bind-the-callbacks"><span class="mr-2">18.3 Bind the callbacks</span><a href="#183-bind-the-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在MenuSetup函数的底部添加代码</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">);</span>
  <span class="p">}</span>
</pre></table></code></div></div><li><p>在MultiplayerSubsystem.cpp中的createsession函数中，如果创建函数失败了，那么就广播这个自定义委托（false）</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">);</span>
  <span class="p">}</span>
</pre></table></code></div></div><li><p>在执行CreateSessionCompleteDelegate委托的回调函数时，自定义委托广播true</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">);</span>
  <span class="p">}</span>
   
  <span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>去实现自定义委托的回调函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
              <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Session created successfully!"</span><span class="p">))</span>
          <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>此时运行可能没反应，是因为要将menu中的那个回调函数设置成UFUNCTION,才能绑定成功（因为用的时dynamic委托）:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>  <span class="c1">//</span>
  <span class="c1">//回调函数（用于MultiplayerSystem的自定义委托）</span>
  <span class="c1">//</span>
  <span class="n">UFUNCTION</span><span class="p">()</span>
  <span class="kt">void</span> <span class="nf">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</pre></table></code></div></div><li><p>将之前的跳转代码从按钮事件剪切到自定义委托的回调函数内</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
              <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Session created successfully!"</span><span class="p">))</span>
          <span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">//成功创建后跳转场景</span>
      <span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="c1">//E:/Ue5/MenuSystem/Content/ThirdPerson/Maps/Lobby.umap</span>
          <span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="s">"/Game/ThirdPerson/Maps/Lobby?listen"</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Red</span><span class="p">,</span>
              <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Failed to create a session!"</span><span class="p">))</span>
          <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>编译测试</p></ol><h3 id="19-more-subsystem-delegates"><span class="mr-2">19. More Subsystem Delegates</span><a href="#19-more-subsystem-delegates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="191-more-delegates"><span class="mr-2">19.1 More delegates</span><a href="#191-more-delegates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>MultiplayerSubsystem.h文件中声明委托，其中有dynamic的意味着可以使用蓝图节点，没有的就不能使用（更深层次的原理不太清除）</p><pre><code class="language-CPP">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnCreateSessionComplete, bool, bWasSuccessful);
DECLARE_MULTICAST_DELEGATE_TwoParam(FMultiplayerOnFindSessionsComplete, const TArray&lt;FOnlineSessionSearchResult&gt;&amp; SessionResult, bool bWasSuccessful);
DECLARE_MULTICAST_DELEGATE_OneParam(FMultiplayerOnJoinSessionComplete, EOnJoinSessionCompleteResult::Type Result);
DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnDestroySessionComplete, bool, bWasSuccessful);
DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnStartSessionComplete, bool, bWasSuccessful);
</code></pre><li><p>创建委托变量</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>  <span class="c1">//</span>
  <span class="c1">//自定义委托变量（用于和menu类的回调函数绑定）</span>
  <span class="c1">//</span>
  <span class="n">FMultiplayerOnCreateSessionComplete</span> <span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">;</span>
  <span class="n">FMultiplayerOnFindSessionsComplete</span> <span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">;</span>
  <span class="n">FMultiplayerOnJoinSessionComplete</span> <span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">;</span>
  <span class="n">FMultiplayerOnDestroySessionComplete</span> <span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">;</span>
  <span class="n">FMultiplayerOnStartSessionComplete</span> <span class="n">MultiplayerOnStartSessionComplete</span><span class="p">;</span>
</pre></table></code></div></div></ol><h4 id="192-menu-callbacks"><span class="mr-2">19.2 Menu callbacks</span><a href="#192-menu-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在menu.h声明回调函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>  <span class="c1">//</span>
  <span class="c1">//回调函数（用于MultiplayerSystem的自定义委托）</span>
  <span class="c1">//</span>
  <span class="n">UFUNCTION</span><span class="p">()</span>
  <span class="kt">void</span> <span class="nf">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">OnFindSessions</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResult</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">OnJoinSession</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
  <span class="n">UFUNCTION</span><span class="p">()</span>
  <span class="kt">void</span> <span class="nf">OnDestroySession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
  <span class="n">UFUNCTION</span><span class="p">()</span>
  <span class="kt">void</span> <span class="nf">OnStartSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</pre></table></code></div></div><li><p>在menu.cpp中menuSetup函数底部绑定回调</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">);</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">AddUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnFindSessions</span><span class="p">);</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">AddUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnJoinSession</span><span class="p">);</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnDestroySession</span><span class="p">);</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnStartSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnStartSession</span><span class="p">);</span>
  <span class="p">}</span>
</pre></table></code></div></div><li><p>OnJoinSession函数会报错，是因为缺少头文件，在头文件文件中添加<code class="language-plaintext highlighter-rouge">#include "Interfaces/OnlineSessionInterface.h""</code></p><li><p>在cpp文件添加头文件<code class="language-plaintext highlighter-rouge">#include "OnlineSessionSettings.h"</code></p><li><p>之后如果突然出现了一些不明不白的红色波浪线，那么重启下项目和vs即可解决</p></ol><h3 id="20-join-sessions-from-the-menu"><span class="mr-2">20. Join sessions from the menu</span><a href="#20-join-sessions-from-the-menu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="201-join-session"><span class="mr-2">20.1 Join session</span><a href="#201-join-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>修改menu.cpp的joinButtonClicked</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">JoinButtonClicked</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">FindSessions</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
  <span class="p">}</span>
   
<span class="p">}</span>
</pre></table></code></div></div><li><p>实现multiplayerSubsystem的findsession函数，在头文件创建私有变量``</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">FindSessions</span><span class="p">(</span><span class="n">int32</span> <span class="n">MaxSearchResults</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//将委托变量加入委托列表</span>
  <span class="n">FindSessionsCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegate</span><span class="p">);</span>
  <span class="c1">//创建会话设置的智能指针,将类的指针makesharable</span>
  <span class="n">LastSessionSearch</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="nf">FOnlineSessionSearch</span><span class="p">());</span>
  <span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">MaxSearchResults</span> <span class="o">=</span> <span class="n">MaxSearchResults</span><span class="p">;</span><span class="c1">//最大搜索个数</span>
  <span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">bIsLanQuery</span> <span class="o">=</span> <span class="n">IOnlineSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSubsystemName</span><span class="p">()</span> <span class="o">==</span> <span class="s">"NULL"</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
   
  <span class="c1">//确保搜索的 会话询问 设置为 现在存在的</span>
  <span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">QuerySettings</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">SEARCH_PRESENCE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">EOnlineComparisonOp</span><span class="o">::</span><span class="n">Equals</span><span class="p">);</span>
  <span class="c1">//获取角色控制器</span>
  <span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
   
  <span class="c1">//执行在线会话接口的寻找会话的函数</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">FindSessions</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">LastSessionSearch</span><span class="p">.</span><span class="n">ToSharedRef</span><span class="p">()))</span><span class="c1">//将ptr转为ref</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCancelFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">);</span>
      <span class="c1">//搜索失败，那么广播时传的参数就是空的TArray</span>
      <span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;</span><span class="p">(),</span> <span class="nb">false</span><span class="p">)</span><span class="err">''</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>实现回调<code class="language-plaintext highlighter-rouge">OnFindSessionsComplete(bool bWasSuccessful)</code></p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">);</span>
  <span class="p">}</span>
   
  <span class="k">if</span> <span class="p">(</span><span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="c1">//没有找到会话，也广播false给menu</span>
  <span class="p">{</span>
      <span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
   
  <span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span> <span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div></ol><h4 id="202-joing-a-session"><span class="mr-2">20.2 Joing a session</span><a href="#202-joing-a-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>实现menu的回调函数OnJoinSession</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnFindSessions</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResult</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//遍历搜索到的所有会话</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">Result</span> <span class="o">:</span> <span class="n">SessionResult</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">FString</span> <span class="n">SettingsValue</span><span class="p">;</span>
      <span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">"MatchType"</span><span class="p">),</span> <span class="n">SettingsValue</span><span class="p">);</span><span class="c1">//将会话中设置的比赛类型存到SettingsVale中</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">SettingsValue</span> <span class="o">==</span> <span class="n">MatchType</span><span class="p">)</span><span class="c1">//如果搜索到的，和我menu设置的menuType一致</span>
      <span class="p">{</span>
          <span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">JoinSession</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>去实现MultiplayerSubsystem的JoinSession函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">JoinSession</span><span class="p">(</span><span class="k">const</span> <span class="n">FOnlineSessionSearchResult</span><span class="o">&amp;</span> <span class="n">SessionResult</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">UnknownError</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
   
  <span class="n">JoinSessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegate</span><span class="p">);</span>
   
  <span class="c1">//获取角色控制器</span>
  <span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">JoinSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">SessionResult</span><span class="p">))</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">);</span>
   
      <span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">UnknownError</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>实现回调函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">OnJoinSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>在menu.cpp实现join的回调,并添加头文件<code class="language-plaintext highlighter-rouge">#include "OnlineSubsystem.h"</code></p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnJoinSession</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">IOnlineSubsystem</span><span class="o">*</span> <span class="n">Subsystem</span> <span class="o">=</span> <span class="n">IOnlineSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">IOnlineSessionPtr</span> <span class="n">SessionInterface</span> <span class="o">=</span> <span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">GetSessionInterface</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
      <span class="p">{</span>
          <span class="n">FString</span> <span class="n">Address</span><span class="p">;</span><span class="c1">//保存要join的地址</span>
          <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">GetResolvedConnectString</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">Address</span><span class="p">);</span>
          <span class="c1">//获得角色控制器指针</span>
          <span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerController</span><span class="p">();</span>
          <span class="c1">//跳转场景</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
          <span class="p">{</span>
              <span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">ClientTravel</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">ETravelType</span><span class="o">::</span><span class="n">TRAVEL_Absolute</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>由于找不到Session，应该是在createSession函数里忘了加<code class="language-plaintext highlighter-rouge">LastSessionSettings-&gt;bUseLobbiesIfAvailable = true;</code>这个了</p></ol><h3 id="21-tracking-incoming-players"><span class="mr-2">21. Tracking Incoming Players</span><a href="#21-tracking-incoming-players" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>    游戏模式：设定规则，处理角色进入游戏、离开游戏。</p><p>    游戏状态：每一个客户端都会监视游戏状态信息，游戏状态是一个类，保存着每个玩家的数据数组</p><p><a href="https://imgtu.com/i/jDilVJ" class="img-link shimmer" ><img data-src="https://s1.ax1x.com/2022/07/08/jDilVJ.jpg" alt="jDilVJjpg" class="lazyload" data-proofer-ignore></a></p><h4 id="211-create-a-game-mode"><span class="mr-2">21.1 Create a game mode</span><a href="#211-create-a-game-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>把game mode创建在MenuSystem文件夹，而不是放在插件里，新建C++类，选择GAME MODE BASE,命名LobbyGameMode</ol><h4 id="212-track-incoming-players"><span class="mr-2">21.2 Track incoming players</span><a href="#212-track-incoming-players" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>在头文件的public下重写函数声明</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">PostLogin</span><span class="p">(</span><span class="n">APlayerController</span><span class="o">*</span> <span class="n">NewPlayer</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Logout</span><span class="p">(</span><span class="n">ACpntroller</span><span class="o">*</span> <span class="n">Exiting</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
</pre></table></code></div></div><li><p>实现两个函数，添加头文件<code class="language-plaintext highlighter-rouge">#include "GameFrameWork/GameStateBase.h"</code>不然会报错</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">ALobbyGameMode</span><span class="o">::</span><span class="n">PostLogin</span><span class="p">(</span><span class="n">APlayerController</span><span class="o">*</span> <span class="n">NewPlayer</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//执行父类的函数</span>
  <span class="n">Super</span><span class="o">::</span><span class="n">PostLogin</span><span class="p">(</span><span class="n">NewPlayer</span><span class="p">);</span>
   
  <span class="k">if</span> <span class="p">(</span><span class="n">GameState</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">int32</span> <span class="n">NumberOfPlayers</span> <span class="o">=</span> <span class="n">GameState</span><span class="p">.</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">PlayerArray</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="c1">//打印玩家数量</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="mi">1</span><span class="p">,</span>
              <span class="mf">60.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
              <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Players in game: %d"</span><span class="p">),</span> <span class="n">NumberOfPlayers</span><span class="p">)</span>
          <span class="p">);</span>
          <span class="c1">//打印进入游戏的玩家名字</span>
          <span class="n">APlayerState</span><span class="o">*</span> <span class="n">PlayerState</span> <span class="o">=</span> <span class="n">NewPlayer</span><span class="o">-&gt;</span><span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">APlayerState</span><span class="o">&gt;</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">PlayerState</span><span class="p">)</span>
          <span class="p">{</span>
              <span class="n">FString</span> <span class="n">PlayerName</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">-&gt;</span><span class="n">GetPlayerName</span><span class="p">();</span><span class="c1">//保存玩家名字</span>
              <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
                  <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                  <span class="mf">60.</span><span class="n">f</span><span class="p">,</span>
                  <span class="n">FColor</span><span class="o">::</span><span class="n">Cyan</span><span class="p">,</span>
                  <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"%s has joined the game!"</span><span class="p">),</span> <span class="o">*</span><span class="n">PlayerName</span><span class="p">)</span>
              <span class="p">);</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
   
<span class="kt">void</span> <span class="n">ALobbyGameMode</span><span class="o">::</span><span class="n">Logout</span><span class="p">(</span><span class="n">AController</span><span class="o">*</span> <span class="n">Exiting</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Super</span><span class="o">::</span><span class="n">Logout</span><span class="p">(</span><span class="n">Exiting</span><span class="p">);</span>
   
  <span class="c1">//打印进入游戏的玩家名字</span>
  <span class="n">APlayerState</span><span class="o">*</span> <span class="n">PlayerState</span> <span class="o">=</span> <span class="n">Exiting</span><span class="o">-&gt;</span><span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">APlayerState</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">PlayerState</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">int32</span> <span class="n">NumberOfPlayers</span> <span class="o">=</span> <span class="n">GameState</span><span class="p">.</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">PlayerArray</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span>
      <span class="c1">//打印玩家数量</span>
      <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
          <span class="mi">1</span><span class="p">,</span>
          <span class="mf">60.</span><span class="n">f</span><span class="p">,</span>
          <span class="n">FColor</span><span class="o">::</span><span class="n">Yellow</span><span class="p">,</span>
          <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Players in game: %d"</span><span class="p">),</span> <span class="n">NumberOfPlayers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">);</span>
      <span class="c1">//打印退出的玩家名字</span>
      <span class="n">FString</span> <span class="n">PlayerName</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">-&gt;</span><span class="n">GetPlayerName</span><span class="p">();</span><span class="c1">//保存玩家名字</span>
      <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
          <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="mf">60.</span><span class="n">f</span><span class="p">,</span>
          <span class="n">FColor</span><span class="o">::</span><span class="n">Cyan</span><span class="p">,</span>
          <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"%s has exited the game!"</span><span class="p">),</span> <span class="o">*</span><span class="n">PlayerName</span><span class="p">)</span>
      <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>在multiplayerSubsystem类的createSession()中添加一行设置</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">BuildUniqueId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//如果不设置的话，就搜索不到其他人创建的房间了</span>
</pre></table></code></div></div><li><p>设置项目最大人数，打开config文件夹中的DefaultGame.ini，添加：</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nn">[/Script/Engine.GameSession]</span>
<span class="py">MaxPlayers</span><span class="p">=</span><span class="s">100</span>
</pre></table></code></div></div><li><p>在ThirdPerson文件夹创建一个蓝图，搜索LobbyGameMode，命名BP_LobbyGameMode</p><li><p>打开蓝图，将Default Pawn Class改为BP_ThirdPersonCharacter,编译并保存</p><li><p>进入Lobby场景，将World Settings的GameMode Override改为BP_LobbyGameMode，Default Pawn Class改为BP_ThirdPersonCharacter，只有这样玩家在场景中移动才能传到服务器</p></ol><h3 id="22-start-session"><span class="mr-2">22. Start Session</span><a href="#22-start-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h3 id="23-path-to-lobby"><span class="mr-2">23. Path to Lobby</span><a href="#23-path-to-lobby" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>在menu头文件创建私有变量<code class="language-plaintext highlighter-rouge">FString PathToLpbby{ TEXT("") };</code></p><li><p>给setup函数添加一个形参<code class="language-plaintext highlighter-rouge">void MenuSetup(int32 NumberOfPublicConnections = 4 , FString TypeOfMatch = FString(TEXT("FreeForAll")), FString LobbyPath = FString(TEXT("/Game/ThirdPerson/Maps/Lobby")));</code></p><li><p>在setup函数顶部添加代码：</p><pre><code class="language-CPP">  //给PathToLobby赋值
  PathToLobby = FString::Printf(TEXT("%s?listen"), *LobbyPath);
</code></pre><li><p>修改createsession函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="n">PathToLobby</span><span class="p">);</span>
</pre></table></code></div></div><li><p>进入初始房间level blueprint，可以修改节点的参数了</p></ol><h3 id="24-polishing-the-menu-subsystem"><span class="mr-2">24. Polishing the Menu Subsystem</span><a href="#24-polishing-the-menu-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="241-create-session-on-destroy"><span class="mr-2">24.1 Create Session on destroy</span><a href="#241-create-session-on-destroy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    当加入他人会话的玩家退回到主界面时，点击host会显示创建失败，但再次点击就会成功，是因为第一次点击destroy了上一个会话就立马create，但实际上还没来得及destroy完，所以需要重新设计下这个删除功能</p><ol><li><p>在MultiplayerSubsystem.h中声明一些私有变量</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  <span class="kt">bool</span> <span class="n">bCreateSessionOnDestroy</span><span class="p">{</span> <span class="nb">false</span> <span class="p">};</span>
  <span class="n">int32</span> <span class="n">LastNumPublicConnection</span><span class="p">;</span>
  <span class="n">FString</span> <span class="n">LastMatchType</span><span class="p">;</span><span class="n">e</span><span class="p">;</span>
</pre></table></code></div></div><li><p>修改createSession中销毁会话部分代码</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>  <span class="c1">//如果有会话存在，那么保存此次创建会话的信息，并在之后创建</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ExistingSession</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">bCreateSessionOnDestroy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">LastNumPublicConnection</span> <span class="o">=</span> <span class="n">NumPublicConnections</span><span class="p">;</span>
      <span class="n">LastMatchType</span> <span class="o">=</span> <span class="n">MatchType</span><span class="p">;</span>
   
      <span class="n">DestroySession</span><span class="p">();</span>
  <span class="p">}</span>
</pre></table></code></div></div><li><p>实现Destroy</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">DestroySession</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="c1">//给menu的回调发送false</span>
      <span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
   
  <span class="n">DestroySessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegate</span><span class="p">);</span>
   
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">DestroySession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">))</span><span class="c1">//如果销毁失败</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">);</span><span class="c1">//清除句柄</span>
      <span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>实现destroy的回调函数</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">UMultiplayerSubsystem</span><span class="o">::</span><span class="n">OnDestroySessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">);</span><span class="c1">//清除句柄</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bWasSuccessful</span> <span class="o">&amp;&amp;</span> <span class="n">bCreateSessionOnDestroy</span><span class="p">)</span><span class="c1">//如果接口的destroy成功且是通过删除再创建新会话</span>
  <span class="p">{</span>
      <span class="n">bCreateSessionOnDestroy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">//重置标记</span>
      <span class="n">CreateSession</span><span class="p">(</span><span class="n">LastNumPublicConnection</span><span class="p">,</span> <span class="n">LastMatchType</span><span class="p">);</span><span class="c1">//创建会话，这样其实会多创一次，但这样保证了一定会创建成功一个</span>
  <span class="p">}</span>
  <span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">);</span><span class="c1">//广播道菜单去</span>
<span class="p">}</span>
</pre></table></code></div></div></ol><h4 id="242-quit-game-button"><span class="mr-2">24.2 Quit Game button</span><a href="#242-quit-game-button" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>    在右上角创建QuitButton即可，直接给按钮添加点击事件退出游戏即可</p><h4 id="243-disable-menu-button"><span class="mr-2">24.3 Disable menu button</span><a href="#243-disable-menu-button" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>修改menu.cpp的按钮事件即可，加上这行：<code class="language-plaintext highlighter-rouge">HostButton-&gt;SetIsEnabled(false);</code></p><li><p>如果创建加入会话失败，那么只需要在回调函数中添加<code class="language-plaintext highlighter-rouge">HostButton-&gt;SetIsEnabled(true);</code></p><p>在find回调中添加：</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">SessionResult</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">bWasSuccessful</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GEngine</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">AddOnScreenDebugMessage</span><span class="p">(</span>
              <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="mf">15.</span><span class="n">f</span><span class="p">,</span>
              <span class="n">FColor</span><span class="o">::</span><span class="n">Red</span><span class="p">,</span>
              <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Sessions Num : 0! or find error!"</span><span class="p">))</span>
          <span class="p">);</span>
      <span class="p">}</span>
      <span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>在join回调底部，如果join失败也<code class="language-plaintext highlighter-rouge">JoinButton-&gt;SetIsEnabled(true);</code></p></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/unreal5/'>Unreal5</a>, <a href='/categories/%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/'>多人在线游戏匹配系统</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF/" class="post-tag no-text-decoration" >多人在线</a> <a href="/tags/onlinesubsystem/" class="post-tag no-text-decoration" >OnlineSubsystem</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3%20-%20CALL1CE&url=%2Fposts%2F%25E5%259F%25BA%25E4%25BA%258EUnreal5%25E5%2592%258CTrueSkill%25E7%259A%2584%25E6%25B8%25B8%25E6%2588%258F%25E5%258C%25B9%25E9%2585%258D%25E7%25B3%25BB%25E7%25BB%259F-%25E5%25A4%259A%25E4%25BA%25BA%25E5%259C%25A8%25E7%25BA%25BF%25E5%258A%259F%25E8%2583%25BD%25E6%258A%2580%25E6%259C%25AF%25E6%2596%2587%25E6%25A1%25A3%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3%20-%20CALL1CE&u=%2Fposts%2F%25E5%259F%25BA%25E4%25BA%258EUnreal5%25E5%2592%258CTrueSkill%25E7%259A%2584%25E6%25B8%25B8%25E6%2588%258F%25E5%258C%25B9%25E9%2585%258D%25E7%25B3%25BB%25E7%25BB%259F-%25E5%25A4%259A%25E4%25BA%25BA%25E5%259C%25A8%25E7%25BA%25BF%25E5%258A%259F%25E8%2583%25BD%25E6%258A%2580%25E6%259C%25AF%25E6%2596%2587%25E6%25A1%25A3%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2F%25E5%259F%25BA%25E4%25BA%258EUnreal5%25E5%2592%258CTrueSkill%25E7%259A%2584%25E6%25B8%25B8%25E6%2588%258F%25E5%258C%25B9%25E9%2585%258D%25E7%25B3%25BB%25E7%25BB%259F-%25E5%25A4%259A%25E4%25BA%25BA%25E5%259C%25A8%25E7%25BA%25BF%25E5%258A%259F%25E8%2583%25BD%25E6%258A%2580%25E6%259C%25AF%25E6%2596%2587%25E6%25A1%25A3%2F&text=%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3%20-%20CALL1CE" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/GAMES105-Lecture-02-Math-Background/">GAMES105-Lecture 02 Math Background</a><li><a href="/posts/GAMES105-Lecture-03-Character-Kinematics/">GAMES105-Lecture 03 Character Kinematics</a><li><a href="/posts/GAMES105-Lecture-01-Introduction-to-Character-Animation/">GAMES105-Lecture 01 Introduction to Character Animation</a><li><a href="/posts/GAMES104-Lecture-12-%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E4%B8%AD%E7%9A%84%E7%B2%92%E5%AD%90%E5%92%8C%E5%A3%B0%E6%95%88%E7%B3%BB%E7%BB%9F/">GAMES104-Lecture 12 游戏引擎中的粒子和声效系统</a><li><a href="/posts/GAMES101-Lecture-16-Ray-Tracing-4-&-%E4%BD%9C%E4%B8%9A7/">GAMES101-Lecture 16 Ray Tracing 4(Monte Carlo Path Tracing) & 作业7</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> <a class="post-tag" href="/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6/">图形学</a> <a class="post-tag" href="/tags/%E6%A8%A1%E6%8B%9F/">模拟</a> <a class="post-tag" href="/tags/%E8%B4%AA%E5%BF%83/">贪心</a> <a class="post-tag" href="/tags/%E5%93%88%E5%B8%8C%E8%A1%A8/">哈希表</a> <a class="post-tag" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E9%81%8D%E5%8E%86/">二叉树的遍历</a> <a class="post-tag" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a> <a class="post-tag" href="/tags/%E5%9B%9E%E6%BA%AF/">回溯</a> <a class="post-tag" href="/tags/%E6%8E%92%E5%BA%8F/">排序</a> <a class="post-tag" href="/tags/%E6%95%B0%E5%AD%A6/">数学</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB-%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/"><div class="card-body"> <em class="small" data-ts="1659497160" data-df="YYYY/MM/DD" > 2022/08/03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>基于Unreal5和TrueSkill的游戏匹配系统-设计文档</h3><div class="text-muted small"><p> 摘 要     在竞技游戏对局中，往往势均力敌的对决才能带来精彩的比赛。游戏内的匹配系统就是根据玩家既往的战绩，对玩家的竞技水平进行评估，将水平接近的玩家匹配到同一房间内进行游戏比赛。本项目使用Unreal5的Subsystem与Steam服务器搭建多人在线系统，并使用TrueSkill算法中的部分算法对正在匹配的玩家进行分组，组成4V4对战，由于时间的限制与TrueSkill算法的难度，...</p></div></div></a></div><div class="card"> <a href="/posts/Learn-How-To-Make-A-2D-Platformer-In-Unreal-Engine-5%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1/"><div class="card-body"> <em class="small" data-ts="1654961400" data-df="YYYY/MM/DD" > 2022/06/11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Learn How To Make A 2D Platformer In Unreal Engine 5学习笔记#1角色动作和滑墙系统</h3><div class="text-muted small"><p> demo视频地址：Learn How To Make A 2D Platformer In Unreal Engine 5学习记录#1 1.1Introduction 创建blank项目，platformer 2dproject（蓝图模式，默认选项，取消掉初学者内容包） 更改自己喜欢的layout（这里就跟教程选择一样的ue4layout了），点击上方...</p></div></div></a></div><div class="card"> <a href="/posts/Learn-How-To-Make-A-2D-Platformer-In-Unreal-Engine-5%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-2%E5%B0%8F%E6%80%AA%E5%B7%A1%E9%80%BB%E7%8A%B6%E6%80%81/"><div class="card-body"> <em class="small" data-ts="1655134980" data-df="YYYY/MM/DD" > 2022/06/13 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Learn How To Make A 2D Platformer In Unreal Engine 5学习笔记#2小怪巡逻状态</h3><div class="text-muted small"><p> demo视频地址：# Learn How To Make A 2D Platformer In Unreal Engine 5学习记录#2小怪巡逻状态 2.1How we are going to set up are enemy characters 在sprite文件夹中创建Enemies文件夹并将资源的Enemies文件夹内容拖入 在Enemie...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E5%9F%BA%E4%BA%8EUnreal5%E5%92%8CTrueSkill%E7%9A%84%E6%B8%B8%E6%88%8F%E5%8C%B9%E9%85%8D%E7%B3%BB-%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/" class="btn btn-outline-primary" prompt="上一篇"><p>基于Unreal5和TrueSkill的游戏匹配系统-设计文档</p></a> <a href="/posts/PAT-Count-PAT's-&-Quick-Sort/" class="btn btn-outline-primary" prompt="下一篇"><p>PAT-Count PAT's & Quick Sort</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> <a class="post-tag" href="/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6/">图形学</a> <a class="post-tag" href="/tags/%E6%A8%A1%E6%8B%9F/">模拟</a> <a class="post-tag" href="/tags/%E8%B4%AA%E5%BF%83/">贪心</a> <a class="post-tag" href="/tags/%E5%93%88%E5%B8%8C%E8%A1%A8/">哈希表</a> <a class="post-tag" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E9%81%8D%E5%8E%86/">二叉树的遍历</a> <a class="post-tag" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a> <a class="post-tag" href="/tags/%E5%9B%9E%E6%BA%AF/">回溯</a> <a class="post-tag" href="/tags/%E6%8E%92%E5%BA%8F/">排序</a> <a class="post-tag" href="/tags/%E6%95%B0%E5%AD%A6/">数学</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/username">CALL1CE</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0">本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> (function () { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE ? "dark" : "default"); let config = {theme: expectedTheme}; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function () { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Create mermaid tag */ $("pre").has("code.language-mermaid").each(function () { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<pre class=\"mermaid\">${svgCode}</pre>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); })(); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { /* start/end delimiter pairs for in-line math */ inlineMath: [ ['$', '$'], ['\\(', '\\)'] ], /* start/end delimiter pairs for display math */ displayMath: [ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
